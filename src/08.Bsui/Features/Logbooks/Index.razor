@page "/Logbooks"

@using Darnton.Blazor.DeviceInterop.Geolocation
@inject IGeolocationService _geolocationService
@using Pertamina.SIMIT.Bsui.Features.Logbooks.Constants
@using Pertamina.SIMIT.Shared.LogbookAttachments.Constants
@using Pertamina.SIMIT.Shared.Logbooks.Queries.GetLogbooks
@using Pertamina.SIMIT.Shared.Logbooks.Constants


<!-- Tampilan jika admin login dengan autorisasi -->
<BrowserTabTitle>@DisplayTextFor.Logbooks</BrowserTabTitle>
<MudBreadcrumbs Items="_breadcrumbItems" Separator=">"></MudBreadcrumbs>
<PageHeader Title="@DisplayTextFor.RekapLogbookMahasiswa" />
<ErrorViewer Error="_error" />

<MudTable Elevation="0" Hover="true" Breakpoint="Breakpoint.Sm"
		  FixedHeader="true" Height="@HeightFor.ScrollableTable" Bordered="true"
		  @ref="_tableLogbooks"
		  ServerData="@(new Func<TableState, Task<TableData<GetLogbooksLogbook>>>(ReloadTableLogbooks))">
	<ToolBarContent>
		<MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" OnClick="ShowDialogAdd">@CommonDisplayTextFor.Add @DisplayTextFor.Logbook</MudButton>
		<MudSpacer />
		<MudTextField Adornment="Adornment.Start" Variant="Variant.Outlined" AdornmentIcon="@Icons.Material.Filled.Search" Placeholder="@CommonDisplayTextFor.Search" T="string" ValueChanged="@(async(keyword) => await OnSearch(keyword))"></MudTextField>
	</ToolBarContent>
	<HeaderContent>
		<MudTh Align="Center" Style="text-align: center;"><MudTableSortLabel SortLabel="@nameof(GetLogbooksLogbook.MahasiswaId)" T="GetLogbooksLogbook">@DisplayTextFor.NoBadgeMahasiswa</MudTableSortLabel></MudTh>
		<MudTh Align="Center" Style="text-align: center;"><MudTableSortLabel SortLabel="@nameof(GetLogbooksLogbook.MahasiswaNama)" T="GetLogbooksLogbook">@DisplayTextFor.NamaMahasiswa</MudTableSortLabel></MudTh>
		<MudTh Align="Center" Style="text-align: center;"><MudTableSortLabel SortLabel="@nameof(GetLogbooksLogbook.LogbookDate)" T="GetLogbooksLogbook">@DisplayTextFor.Tanggal</MudTableSortLabel></MudTh>
		<MudTh Align="Center" Style="text-align: center;"><MudTableSortLabel SortLabel="@nameof(GetLogbooksLogbook.Aktifitas)" T="GetLogbooksLogbook">@DisplayTextFor.Aktifitas</MudTableSortLabel></MudTh>
		<MudTh Align="Center" Style="text-align: center;"><MudTableSortLabel SortLabel="@nameof(GetLogbooksLogbook.LogbookDate)" T="GetLogbooksLogbook">@DisplayTextFor.StatusLogbookPagi</MudTableSortLabel></MudTh>
		<MudTh Align="Center" Style="text-align: center;"><MudTableSortLabel SortLabel="@nameof(GetLogbooksLogbook.LogbookDate)" T="GetLogbooksLogbook">@DisplayTextFor.StatusLogbookSiang</MudTableSortLabel></MudTh>
	</HeaderContent>
	<RowTemplate>
		<MudTd DataLabel="@DisplayTextFor.NoBadgeMahasiswa" Style="text-align: center;">
			<MudHighlighter Text="@context.MahasiswaNim.ToString()" HighlightedText="@_searchKeyword" />
		</MudTd>
		<MudTd DataLabel="@DisplayTextFor.NamaMahasiswa" Style="text-align: center;">
			<MudHighlighter Text="@context.MahasiswaNama.ToString()" HighlightedText="@_searchKeyword" />
		</MudTd>
		<MudTd DataLabel="@DisplayTextFor.Logbook" Style="text-align: center;">
			<MudHighlighter Text="@context.LogbookDate.ToString()" HighlightedText="@_searchKeyword" />
		</MudTd>
		<MudTd DataLabel="@DisplayTextFor.Aktifitas" Style="text-align: center;">
			<MudHighlighter Text="@context.Aktifitas.ToString()" HighlightedText="@_searchKeyword" />
		</MudTd>
		<MudTd DataLabel="@DisplayTextFor.StatusLogbookPagi" Style="text-align: center;">
			@if (context.LogbookId != null && context.LogbookDate.TimeOfDay >= TimeSpan.FromHours(7) && context.LogbookDate.TimeOfDay < TimeSpan.FromHours(12))
			{
				<MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" />
			}
			else
			{
				<MudIcon Icon="@Icons.Material.Filled.Cancel" Color="Color.Error" />
			}
		</MudTd>

		<MudTd DataLabel="@DisplayTextFor.StatusLogbookSiang" Style="text-align: center;">
			@if (context.LogbookId != null && context.LogbookDate.TimeOfDay >= TimeSpan.FromHours(13) && context.LogbookDate.TimeOfDay < TimeSpan.FromHours(16))
			{
				<MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" />
			}
			else
			{
				<MudIcon Icon="@Icons.Material.Filled.Cancel" Color="Color.Error" />
			}
		</MudTd>

	</RowTemplate>
	<PagerContent>
		<MudTablePager />
	</PagerContent>

</MudTable>

@if (IsMorningSession)
{

	<!-- Tampilan jika halaman diakses pada pagi hari-->

	<div style="display: flex; justify-content: center; align-items: center;">
		<MudText Typo="Typo.h5"><b>Tambahkan Logbook Harian</b></MudText>
	</div>


	<div style="display: flex; justify-content: center; align-items: center;">
		<MudCard Outlined="true" Style="width: 1000px; text-align: center; height: max-content">
			<MudCardContent>
				<MudText Typo="Typo.button" HtmlTag="h3"><b>Logbook Sesi Pagi 07.00 - 12.00</b></MudText>

				<EditForm Model="_model" OnValidSubmit="OnValidSubmit" OnInvalidSubmit="OnInvalidSubmit">
					<FluentValidationValidator />
					<div style="text-align: center;">
						<video id="video" autoplay playsinline style="width: 100%; max-height: 300px; border: 1px solid gray;"></video>
						<canvas id="canvas" style="display: none;"></canvas>
						<div>
							<MudButton Variant="Variant.Filled" Color="Color.Info" StartIcon="@Icons.Material.Filled.Camera" OnClick="StartCamera">
								@DisplayTextFor.StartKamera
							</MudButton>
							<MudButton Variant="Variant.Filled" Color="Color.Info" StartIcon="@Icons.Material.Filled.Upload" OnClick="CapturePhoto">
								@DisplayTextFor.AmbilFoto
							</MudButton>
							<MudButton Variant="Variant.Filled" Color="Color.Info" StartIcon="@Icons.Material.Filled.SwapHoriz" OnClick="SwitchCamera">
								@DisplayTextFor.SwitchKamera
							</MudButton>
						</div>
						@if (_capturedPhoto != null)
						{
							<img src="@_capturedPhoto" alt="Captured Photo" style="width: 100%;" />
						}
					</div>
					<MudGrid>
						<MudItem xs="12">
							<MudText Style="text-align: left">No.Badge Mahasiswa</MudText>
							<MudTextField @bind-Value="_model.MahasiswaNim" Label="Masukkan No Badge" Variant="Variant.Outlined" Required="true" />
						</MudItem>
						<MudItem xs="12">
							<MudText Style="text-align: left">Tanggal</MudText>
							<!-- Tanggal otomatis diatur ke hari ini dan tidak dapat diedit -->
							<MudTextField Value="@_model.LogbookDate.ToString("yyyy-MM-dd")" Label="Tanggal" Variant="Variant.Outlined" Disabled="true" />
						</MudItem>
						<MudItem xs="12">
							<MudTextField @bind-Value="_model.Aktifitas" Label="Aktivitas" Variant="Variant.Outlined" Required="true" />
						</MudItem>
					</MudGrid>
					

					<MudCardContent>
						<BottomButtonPanel>
							<MudButton Variant="Variant.Filled" Color="Color.Default" OnClick="Cancel">@CommonDisplayTextFor.Cancel</MudButton>
							<MudButton Variant="Variant.Filled" Color="Color.Primary" ButtonType="ButtonType.Submit">@CommonDisplayTextFor.Add</MudButton>
						</BottomButtonPanel>
					</MudCardContent>
				</EditForm>
			</MudCardContent>
		</MudCard>
	</div>
}
else if (IsAfternoonSession)
{


	<!-- Tampilan jika halaman diakses pada siang hari-->
	<div style="display: flex; justify-content: center; align-items: center;">
		<MudText Typo="Typo.h5"><b>Tambahkan Logbook Harian</b></MudText>
	</div>


	<div style="display: flex; justify-content: center; align-items: center;">
		<MudCard Outlined="true" Style="width: 1000px; text-align: center; height: max-content">
			<MudCardContent>
				<MudText Typo="Typo.button" HtmlTag="h3"><b>Logbook Sesi Siang 13.00 - 16.00</b></MudText>

				<EditForm Model="_model" OnValidSubmit="OnValidSubmit" OnInvalidSubmit="OnInvalidSubmit">
					<FluentValidationValidator />
					<div style="text-align: center;">
						<video id="video" autoplay playsinline style="width: 100%; max-height: 300px; border: 1px solid gray;"></video>
						<canvas id="canvas" style="display: none;"></canvas>
						<div>
							<MudButton Variant="Variant.Filled" Color="Color.Info" StartIcon="@Icons.Material.Filled.Camera" OnClick="StartCamera">
								@DisplayTextFor.StartKamera
							</MudButton>
							<MudButton Variant="Variant.Filled" Color="Color.Info" StartIcon="@Icons.Material.Filled.Upload" OnClick="CapturePhoto">
								@DisplayTextFor.AmbilFoto
							</MudButton>
							<MudButton Variant="Variant.Filled" Color="Color.Info" StartIcon="@Icons.Material.Filled.SwapHoriz" OnClick="SwitchCamera">
								@DisplayTextFor.SwitchKamera
							</MudButton>
						</div>
						@if (_capturedPhoto != null)
						{
							<img src="@_capturedPhoto" alt="Captured Photo" style="width: 100%;" />
						}
					</div>
					<MudGrid>
						<MudItem xs="12">
							<MudText Style="text-align: left">No.Badge Mahasiswa</MudText>
							<MudTextField @bind-Value="_model.MahasiswaNim" Label="Masukkan No Badge" Variant="Variant.Outlined" Required="true" />
						</MudItem>
						<MudItem xs="12">
							<MudText Style="text-align: left">Tanggal</MudText>
							<!-- Tanggal otomatis diatur ke hari ini dan tidak dapat diedit -->
							<MudTextField Value="@_model.LogbookDate.ToString("yyyy-MM-dd")" Label="Tanggal" Variant="Variant.Outlined" Disabled="true" />
						</MudItem>
						<MudItem xs="12">
							<MudTextField @bind-Value="_model.Aktifitas" Label="Aktivitas" Variant="Variant.Outlined" Required="true" />
						</MudItem>
					</MudGrid>

					<MudCardContent>
						<BottomButtonPanel>
							<MudButton Variant="Variant.Filled" Color="Color.Default" OnClick="Cancel">@CommonDisplayTextFor.Cancel</MudButton>
							<MudButton Variant="Variant.Filled" Color="Color.Primary" ButtonType="ButtonType.Submit">@CommonDisplayTextFor.Add</MudButton>
						</BottomButtonPanel>
					</MudCardContent>
				</EditForm>
			</MudCardContent>
		</MudCard>
	</div>
}
else
{
	<MudText Typo="Typo.h6" Style="text-align: center; margin-top: 20px;">Saat ini tidak ada sesi logbook yang tersedia.</MudText>
}
